<head>
	<script src="plotly-latest.min.js"></script>
</head>

<!--<div id="tester" style="width:600px;height:250px;"></div>-->

<body>
	<div id="userinput"></div>
	<div id="directions"></div>
	<div id="endgame"></div>
	<div id="restart"></div>
	<!--<div id="resumegame"></div>-->
	<div id="resumegame"></div>
	<div id="restartgame"></div>
	<div id="results"></div>
	<div id="table"></div>
	<div id="userinput"></div>
</body>


<script>
	//about javascript synchronous/asynchronous
	//https://stackoverflow.com/questions/2035645/when-is-javascript-synchronous
	//as a note, setTimeout does NOT stop the code below it from running.
	window.onload = function() {
		/***************
		*  CONSTANTS  *
		***************/

		//sets the [default] range of values for random number generation
		const MIN = 0;
		const MAX = 1;

		//sets the [default] size of our matrix of data
		const ROWS = 10;
		const COLS = 10;

		//sets how long the visuals will be displayed
		//const WAIT_MILLIS = 5000;
		const WAIT_MILLIS = 3500;

		//name of graph
		const NAME = 'table';
		const RESULT_NAME = 'results';

		
		const RESPONSES = [];
		const CORRECT_RESPONSES = [];

		/***************
		*  FUNCTIONS  *
		***************/

		// generates a random int between min and max
		function randGen(min, max)
		{
			return Math.round(Math.random() * (max-min) + min);
		}

		// Generates a rows by cols matrix of ints between min and max
		function matrixGen(co, ro, min, max)
		{
			var matrix = [];

			for (i = 0; i < co; i++)
			{
				temp = [];
				for (j = 0; j < ro; j++)
				{
					temp.push(randGen(min,max));
				}
				matrix.push(temp);
			}

			return matrix;
		}

		//plots a table of default size in the default range
		plotRandTable = function() {
			//original
			//let valueArray = matrixGen(COLS, ROWS, MIN, MAX);

			//avoiding empty header
			let valueArray = matrixGen(COLS, ROWS-1, MIN, MAX);
			let valueHeader = [];
			for (j = 0; j < 10; j++) {
				valueHeader.push([randGen(0,1)]);
			}
			let freqs = [0,0];
			valueArray.forEach(function(subarr) {
				subarr.forEach(function(el) {
					freqs[el]++;
				});
			});
			if (freqs[0] < freqs[1]) {
				CORRECT_RESPONSES.push("1");
			} else if (freqs[0] > freqs[1]) {
				CORRECT_RESPONSES.push("0");
			} else {
				CORRECT_RESPONSES.push("="); //TODO figure out a better system for ties
			}

			let tableParams = [{
				type: 'table',
				header: {
					//values: [], //original
					values: valueHeader, //avoiding empty header
					align: "center",
					line: {width: 1, color: 'black'},
					fill: {color: "white"},
					font: {family: "Arial", size: 11, color: "black"},
					height: 20
				},
				cells: {
					values: valueArray,
					align: "center",
					line: {color: "black", width: 1},
					font: {family: "Arial", size: 11, color: ["black"]},
					height: 20
				}
			}];

			Plotly.plot(NAME, tableParams);
		}

		//clears visuals and adds the option to give user input
		//input may need to be reworked/given more names, etc to put it in a table
		clearVis = function() {
			Plotly.purge(NAME);
			document.getElementById('directions').innerHTML = "";
			document.getElementById('userinput').innerHTML = "<div><label>Your guess here: </label><input type=\"text\" id=\"usertext\"></div><div><button id=\"userclick\" onclick = \"offerInput();\">Submit</button></div>";
			document.getElementById('endgame').innerHTML = "<button onclick=\"endGame();\">Submit and end game</button>";
		}

		//when the user submits a guess, this function is called.
		offerInput = function() {
			let inputobj = document.getElementById('usertext').value;
			//TODO some sort of input sanitization???
			if (inputobj.length > 2) {
				alert("Enter a realistic guess.");
			} else {
				RESPONSES.push(inputobj);
				document.getElementById('endgame').innerHTML = "";
				document.getElementById('userinput').innerHTML = "";

				//repeat it all
				document.getElementById('directions').innerHTML = "Find the mode (the most common number) in the graph below. Use 1, 0, or =";
				setTimeout('plotRandTable();', WAIT_MILLIS);
				setTimeout('clearVis();', WAIT_MILLIS*2);
			}
		}

		//when the user ends the game, this function is called.
		endGame = function() {
			var inputobj = document.getElementById('usertext').value;
			if (inputobj.length > 2) {
				alert("Enter a realistic guess.");
			}	else {
				//some sort of input cleansing???
				RESPONSES.push(inputobj);
				
				//alert(inputobj);
				document.getElementById('userinput').innerHTML = "";
				document.getElementById('endgame').innerHTML = "";
				document.getElementById('directions').innerHTML = "";
				//document.getElementById('resumegame').innerHTML = "<button onclick=\"resumeGame();\">Resume game</button>";
				document.getElementById('restart').innerHTML = "<button onclick='reset()'>Restart game</button>";
				//todo: save and display results

				var resultTableParams = [{
					type: 'table',
					header: {
						values: [["Correct responses"], ["Your responses"]],
						align: "center",
						line: {width: 1, color: 'black'},
						fill: {color: "gray"},
						font: {family: "Arial", size: 12, color: "white"},
						height: 28
					},
					cells: {
						values: [CORRECT_RESPONSES,RESPONSES],
						align: "center",
						line: {color: "black", width: 1},
						font: {family: "Arial", size: 11, color: ["black"]},
						height: 20
					}
				}];

				Plotly.plot(RESULT_NAME, resultTableParams);
				//document.getElementById('results').innerHTML = "(todo: add results table)";
			}
		}

		reset = function() {
				//clear out the screen
				document.getElementById('restart').innerHTML = "";
				Plotly.purge(RESULT_NAME);

				//clear out the response lists
				RESPONSES.length = 0;
				CORRECT_RESPONSES.length = 0;
				
				//continue on with the new game
				main();
		}	
	
		//when the user resumes the game, this function is called.
		resumeGame = function() {
			document.getElementById('resumegame').innerHTML = "";
			document.getElementById('restartgame').innerHTML = "";
			Plotly.purge(RESULT_NAME);
			document.getElementById('directions').innerHTML = "Find the mode (the most common number) in the graph below. Use 1, 0, or =";
			setTimeout('plotRandTable();', WAIT_MILLIS);
			setTimeout('clearVis();', WAIT_MILLIS*2);
		}

		/***************
		*  MAIN BODY  *
		***************/
		function main() {	
			//display instructions
			document.getElementById('directions').innerHTML = "Find the mode (the most common number) in the graph below. Use 1, 0, or =";
			
			//start first round after WAIT_MILLIS
			setTimeout(plotRandTable, WAIT_MILLIS);	
			setTimeout(clearVis, WAIT_MILLIS*2);
		}

		main();
	};

</script>
